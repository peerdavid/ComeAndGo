@import org.pac4j.core.profile.CommonProfile
@import business.timetracking.TimeTrackState
@import utils.DateTimeUtils
@(profile: CommonProfile, userState: TimeTrackState, timeTracks: java.util.List[TimeTrack])

@script = {
    <!-- JS for updating progress -->
    <script>
            /*
             * get progress by ajax call
             */
            var updateProgress = function(){
                $.ajax({
                    type:  'GET',
                    contentType: 'application/json',
                    data: '',
                    url: '/progress',
                    success: function(data, textStatus, jqXHR) {
                        var json = JSON.parse(data);
                        var progress = json.progress;
                        var overtime = json.overtime;

                        if(progress <= 0){
                            return;
                        }

                        $('#active_progress .determinate').css("width", progress + "%");
                        if(overtime > 0) {
                            $('#overtime-badge').css('visibility', 'visible');
                            $('#overtime-count').text(overtime);
                        }
                    },
                    error:function(jqXHR, textStatus, errorThrown) {
                        console.log("Progess update failed " + textStatus);
                    }
                });
            }

            $( document ).ready(function() {
                updateProgress();
                // update progress every minute
                setInterval(updateProgress, 60000);
            });
    </script>
}

@main(Messages("views.index.title"), script) {

    @navigation(Messages("views.index.title"), profile) {

        <!-- Title -->
        <div id = "index-welcome-status" class="row">
            <div class="s12">
                <h3>@(Messages("views.index.welcomeMessage") + " : " + profile.getUsername)</h3>

                @if(userState == TimeTrackState.INACTIVE) {
                    <h4>@(Messages("views.index.state") + " : " + Messages("views.index.state.inactive"))</h4>
                }
                @if(userState == TimeTrackState.ACTIVE) {
                    <h4>@(Messages("views.index.state") + " : " + Messages("views.index.state.active"))</h4>
                }
                @if(userState == TimeTrackState.PAUSE) {
                    <h4>@(Messages("views.index.state") + " : " + Messages("views.index.state.pause"))</h4>
                }
            </div>
        </div>

        <!-- Progress bar -->
        <div id="active_progress" class="progress row">
            <div class="determinate green col s12 l12" style="width: 0%"></div>
            <span id="overtime-badge" class="badge green white-text valign-wrapper z-depth-1" style="visibility: hidden">
                <i class="material-icons valign">add</i><span id="overtime-count" class="valign">1.2</span>
            </span>
        </div>

        <!-- Current state -->
        <div class="row">
            <div class="s12">
                @if(userState == TimeTrackState.INACTIVE) {
                    <div id="index-time-track-buttons" class="row">
                        <a class="waves-effect waves-light btn secondary-btn col s12 m4 l2" href="@routes.TimeTrackController.come()"> @Messages("views.index.come")</a>
                        <button class="waves-effect waves-light btn secondary-btn col s12 m4 l2 offset-l3" disabled="disabled">@Messages("views.index.startbreak")</button>
                        <button class="waves-effect waves-light btn secondary-btn col s12 m4 l2 offset-l3" disabled="disabled">@Messages("views.index.go")</button>
                    </div>
                }

                @if(userState == TimeTrackState.ACTIVE) {
                    <div id="index-time-track-buttons" class="row">
                        <button class="waves-effect waves-light btn secondary-btn col s2" disabled="disabled" style="float : left"> @Messages("views.index.come")</button>
                        <a class="waves-effect waves-light btn secondary-btn col s2 offset-l3" href="@routes.TimeTrackController.pause()">@Messages("views.index.startbreak")</a>
                        <a class="waves-effect waves-light btn secondary-btn col s2 offset-l3" href="@routes.TimeTrackController.go()" style="float : right">@Messages("views.index.go")</a>
                    </div>
                }

                @if(userState == TimeTrackState.PAUSE) {
                    <div id="index-time-track-buttons" class="row">
                        <button class="waves-effect waves-light btn secondary-btn col s2" disabled="disabled" style="float : left"> @Messages("views.index.come")</button>
                        <a class="waves-effect waves-light btn secondary-btn col s2 offset-l3" href="@routes.TimeTrackController.pause()">@Messages("views.index.stopbreak")</a>
                        <button class="waves-effect waves-light btn secondary-btn col s2 offset-l3" disabled="disabled" style="float : right">@Messages("views.index.go")</button>
                    </div>
                }
            </div>
        </div>

        <!-- Todays time trackings -->
        <div class="row">
            <div class="s12">
        @if(!timeTracks.isEmpty) {
            <table>
                <tr>
                    <th>
                        @Messages("views.index.timetrack.tablehead.action")
                    </th>
                    <th>
                        @Messages("views.index.timetrack.tablehead.time")
                    </th>
                </tr>
                @for(timeTrack: TimeTrack <- timeTracks) {
                    <tr>
                        <td>
                            @Messages("views.index.timetrack.tablebody.start")
                        </td>
                        <td>
                            @(DateTimeUtils.dateTimeToTimeString(timeTrack.getFrom))
                        </td>
                    </tr>

                    @for(b: Break <- timeTrack.getBreaks) {
                        <tr>
                            <td>
                                @Messages("views.index.timetrack.tablebody.breakstart")
                            </td>
                            <td>
                                @(DateTimeUtils.dateTimeToTimeString(b.getFrom))
                            </td>
                        </tr>

                        @if(b.getTo() != null) {
                            <tr>
                                <td>
                                    @Messages("views.index.timetrack.tablebody.breakend")
                                </td>
                                <td>
                                    @(DateTimeUtils.dateTimeToTimeString(b.getTo))
                                </td>
                            </tr>
                        }
                    }

                    @if(timeTrack.getTo() != null) {
                        <tr>
                            <td>
                                @Messages("views.index.timetrack.tablebody.end")
                            </td>
                            <td>
                                @(DateTimeUtils.dateTimeToTimeString(timeTrack.getTo))
                            </td>
                        </tr>
                    }

                }
            </table>

        }
            </div>
        </div>
    }

}
